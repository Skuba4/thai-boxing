{% extends 'base.html' %}

{% block content %}
<main>
    {% if is_boss %}
        <h2>Главный судья</h2>
        <button id="addJudgeBtn">Добавить судью</button>
        <button id="setActiveJudgeBtn">Назначить активных судей</button>

        <h3>Список боев</h3>
        <div id="fight-list">
            {% for fight in fights %}
                <div class="fight" data-fight-id="{{ fight.id }}">
                    <p class="fight-info">
                        {{ fight.number_fight }}: {{ fight.fighter_1 }} vs {{ fight.fighter_2 }}
                        <span class="fight-links">
                            <a href="#" class="editFight">Изменить</a> |
                            <a href="#" class="deleteFight">Удалить</a> |
                            <a href="#" class="viewNotes">Записки</a> |
                            <a href="#" class="finalDecision">Результат</a>
                        </span>
                    </p>
                </div>
            {% endfor %}
        </div>

        <button id="addFightBtn">Добавить бой</button>
        <div id="fightFormContainer" style="display:none;">
            <form id="fightForm" method="POST" data-uuid="{{ uuid }}">
                {% csrf_token %}
                <label>Номер боя:</label>
                <input type="number" name="number_fight" required>
                <label>Боец 1:</label>
                <input type="text" name="fighter_1" required>
                <label>Боец 2:</label>
                <input type="text" name="fighter_2" required>
                <button type="submit">Добавить</button>
            </form>
        </div>


    {% elif is_active_judge %}
        <h2>Активный боковой судья</h2>
        <h3>Список боев</h3>
        <div id="fight-list">
            {% for fight in fights %}
                <div class="fight" data-fight-id="{{ fight.id }}">
                    <p class="fight-info">
                        {{ fight.number_fight }}: {{ fight.fighter_1 }} vs {{ fight.fighter_2 }}
                        <span class="fight-links">
                            <a href="#" class="viewNotes">1 раунд</a>
                            <a href="#" class="viewNotes">2 раунд</a>
                            <a href="#" class="viewNotes">3 раунд</a>
                        </span>
                    </p>
                </div>
            {% endfor %}
        </div>


    {% else %}
        <h2>Наблюдатель</h2>
        <h3>Список боев</h3>
        <div id="fight-list">
            {% for fight in fights %}
                <div class="fight" data-fight-id="{{ fight.id }}">
                    <p class="fight-info">
                        {{ fight.number_fight }}: {{ fight.fighter_1 }} vs {{ fight.fighter_2 }}
                        <span class="fight-links">
                            <a href="#" class="viewNotes">Записки</a>
                        </span>
                    </p>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addFightBtn = document.getElementById('addFightBtn');
        const fightFormContainer = document.getElementById('fightFormContainer');
        const fightForm = document.getElementById('fightForm');
        const fightList = document.getElementById('fight-list');

        if (addFightBtn) {
            addFightBtn.addEventListener('click', function() {
                fightFormContainer.style.display = 'block';
            });
        }

        if (fightForm) {
            fightForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(fightForm);
                const uuidRoom = fightForm.dataset.uuid;
                fetch(`/create_fight/${uuidRoom}/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
                        'X-Requested-With': 'XMLHttpRequest'  // ✅ Принудительно указываем AJAX
                    }
                })

                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        fightList.innerHTML = data.fights_html; // Обновляем список боёв
                        fightForm.reset(); // Очищаем форму
                        fightFormContainer.style.display = 'none'; // Закрываем форму
                    } else {
                        alert('Ошибка при создании боя');
                    }
                })
                .catch(error => {
                    console.error('Ошибка AJAX:', error);
                    alert('Ошибка соединения');
                });
            });
        }
    });
</script>

{% endblock %}



